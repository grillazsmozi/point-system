<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sorverseny Állomás | Betöltés</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css"
      rel="stylesheet"
    />
    <style>
      :where([class^="ri-"])::before { content: "\f3c2"; }
      @font-face {
      font-family: 'SF Pro Display';
      src: local('SF Pro Display');
      }
      .code-input {
      transition: all 0.3s ease;
      }
      .code-circle {
      transition: all 0.2s ease;
      }
      .code-circle.filled {
      background-color: #1D1D1F;
      border-color: #1D1D1F;
      }
      .numpad-btn {
      transition: all 0.15s ease;
      -webkit-tap-highlight-color: transparent;
      opacity: 0;
      transform: translateY(20px);
      }
      .numpad-btn.show {
      opacity: 1;
      transform: translateY(0);
      }
      .numpad-btn:active {
      transform: scale(0.97);
      }
      @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      75% { transform: translateX(6px); }
      }
      .shake {
      animation: shake 0.4s ease-in-out;
      }
      @keyframes fadeInDown {
      from {
      opacity: 0;
      transform: translateY(-20px);
      }
      to {
      opacity: 1;
      transform: translateY(0);
      }
      }
      .fade-in-down {
      animation: fadeInDown 0.3s ease-out forwards;
      }
      .code-circle {
      opacity: 0;
      transform: scale(0.8);
      }
      .code-circle.animate {
      animation: scaleIn 0.4s ease-out forwards;
      }
      @keyframes scaleIn {
      from {
      opacity: 0;
      transform: scale(0.9);
      }
      to {
      opacity: 1;
      transform: scale(1);
      }
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#007AFF",
              secondary: "#F5F5F7",
            },
            borderRadius: {
              none: "0px",
              sm: "4px",
              DEFAULT: "8px",
              md: "12px",
              lg: "16px",
              xl: "20px",
              "2xl": "24px",
              "3xl": "32px",
              full: "9999px",
              button: "8px",
            },
          },
        },
      };
    </script>
  </head>
  <body class="min-h-screen bg-white"> <!-- --> 
    <div id="sidebar" class="fixed top-0 left-0 h-80 w-64 bg-white -translate-x-full shadow-lg transform transition-transform duration-300 z-50 rounded-xl">
      <div class="flex items-center justify-between px-4 py-3 border-b">
        <h2 id="profile-title" class="text-lg font-semibold text-[#1D1D1F]" style="font-family: 'SF Pro Display'">Profil</h2>
        <!-- nyíl gomb -->
        <button id="toggleSidebar" class="text-2xl text-[#1D1D1F] focus:outline-none">
          <i class="ri-arrow-right-s-line"></i>
        </button>
      </div>
      <div class="p-4 text-[#1D1D1F]" style="font-family: 'SF Pro Display'" id="profile-desc">
        Adjon meg játékos azonosítót...
      </div>
    </div>
    <!-- Gomb, ami megjelenik zárt állapotban is -->
<button id="openSidebar" class="fixed top-4 left-0 z-40 bg-white border-r rounded-r-md px-2 py-1 shadow text-[#1D1D1F] text-xl">
  <i class="ri-arrow-left-s-line"></i>
</button>

    <div class="max-w-md mx-auto px-6 py-12">
      <header class="text-center mb-16 opacity-0">
        <h1
          class="text-2xl font-semibold text-[#1D1D1F] mb-2"
          style="font-family: 'SF Pro Display', -apple-system, sans-serif"
          id="stationName"
        >
          Betöltés...
        </h1>
        <p
          class="text-[#86868B]"
          style="font-family: 'SF Pro Display', -apple-system, sans-serif" id="desc"
        >
          Adja meg a játékos azonosítóját.
        </p>
      </header>
      <div
        class="code-display flex justify-center space-x-4 mb-16"
        id="codeDisplay"
      >

      <h3
          class="text-2xl font-semibold text-[#1D1D1F] mb-2"
          style="font-family: 'SF Pro Display', -apple-system, sans-serif; padding: none;"
          id="code"
        >
        
        </h3>
    </div>
      <div class="numpad grid grid-cols-3 gap-3">
        <button
          class="numpad-btn h-[75px] rounded-full bg-[#F5F5F7] flex items-center justify-center text-[27px] font-light text-[#1D1D1F] cursor-pointer hover:bg-[#E5E5E5] active:bg-[#D1D1D6]"
          style="font-family: 'SF Pro Display', -apple-system, sans-serif"
        >
          1
        </button>
        <button
          class="numpad-btn h-[75px] rounded-full bg-[#F5F5F7] flex items-center justify-center text-[27px] font-light text-[#1D1D1F] cursor-pointer hover:bg-[#E5E5E5] active:bg-[#D1D1D6]"
          style="font-family: 'SF Pro Display', -apple-system, sans-serif"
        >
          2
        </button>
        <button
          class="numpad-btn h-[75px] rounded-full bg-[#F5F5F7] flex items-center justify-center text-[27px] font-light text-[#1D1D1F] cursor-pointer hover:bg-[#E5E5E5] active:bg-[#D1D1D6]"
          style="font-family: 'SF Pro Display', -apple-system, sans-serif"
        >
          3
        </button>
        <button
          class="numpad-btn h-[75px] rounded-full bg-[#F5F5F7] flex items-center justify-center text-[27px] font-light text-[#1D1D1F] cursor-pointer hover:bg-[#E5E5E5] active:bg-[#D1D1D6]"
          style="font-family: 'SF Pro Display', -apple-system, sans-serif"
        >
          4
        </button>
        <button
          class="numpad-btn h-[75px] rounded-full bg-[#F5F5F7] flex items-center justify-center text-[27px] font-light text-[#1D1D1F] cursor-pointer hover:bg-[#E5E5E5] active:bg-[#D1D1D6]"
          style="font-family: 'SF Pro Display', -apple-system, sans-serif"
        >
          5
        </button>
        <button
          class="numpad-btn h-[75px] rounded-full bg-[#F5F5F7] flex items-center justify-center text-[27px] font-light text-[#1D1D1F] cursor-pointer hover:bg-[#E5E5E5] active:bg-[#D1D1D6]"
          style="font-family: 'SF Pro Display', -apple-system, sans-serif"
        >
          6
        </button>
        <button
          class="numpad-btn h-[75px] rounded-full bg-[#F5F5F7] flex items-center justify-center text-[27px] font-light text-[#1D1D1F] cursor-pointer hover:bg-[#E5E5E5] active:bg-[#D1D1D6]"
          style="font-family: 'SF Pro Display', -apple-system, sans-serif"
        >
          7
        </button>
        <button
          class="numpad-btn h-[75px] rounded-full bg-[#F5F5F7] flex items-center justify-center text-[27px] font-light text-[#1D1D1F] cursor-pointer hover:bg-[#E5E5E5] active:bg-[#D1D1D6]"
          style="font-family: 'SF Pro Display', -apple-system, sans-serif"
        >
          8
        </button>
        <button
          class="numpad-btn h-[75px] rounded-full bg-[#F5F5F7] flex items-center justify-center text-[27px] font-light text-[#1D1D1F] cursor-pointer hover:bg-[#E5E5E5] active:bg-[#D1D1D6]"
          style="font-family: 'SF Pro Display', -apple-system, sans-serif"
        >
          9
        </button>
        <button
          class="numpad-btn h-[75px] rounded-full bg-[#F5F5F7] flex items-center justify-center text-[27px] text-[#1D1D1F] cursor-pointer hover:bg-[#E5E5E5] active:bg-[#D1D1D6]"
          id="done"
        >
          <i class="ri-check-line text-2xl"></i>
        </button>
        <button
          class="numpad-btn h-[75px] rounded-full bg-[#F5F5F7] flex items-center justify-center text-[27px] font-light text-[#1D1D1F] cursor-pointer hover:bg-[#E5E5E5] active:bg-[#D1D1D6]"
          style="font-family: 'SF Pro Display', -apple-system, sans-serif"
        >
          0
        </button>
        <button
          class="numpad-btn h-[75px] rounded-full bg-[#F5F5F7] flex items-center justify-center text-[27px] text-[#1D1D1F] cursor-pointer hover:bg-[#E5E5E5] active:bg-[#D1D1D6]"
          id="backspace"
        >
          <i class="ri-delete-back-2-line text-2xl"></i>
        </button>
        
        <button
          class="numpad-btn h-[20px] rounded-full bg-[#F5F5F7] flex items-center justify-center text-[16px] font-normal text-[#1D1D1F] cursor-pointer hover:bg-[#E5E5E5] active:bg-[#D1D1D6]"
          style="font-family: 'SF Pro Display', -apple-system, sans-serif; margin-top: 15px"
        >
          Vissza
        </button>
      </div>
    </div>

    <form id="newUserForm">
      <input type="hidden" id="userid" name="userid">
      <input type="hidden" id="stationid" name="stationid">
      <input type="hidden" id="point" name="point">
    </form>
    <button id="supportCallBtn" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
  width: 60px;
  height: 60px;
  background-color: #e53935;
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  cursor: pointer;
">
  <i class="ri-phone-fill"></i>
</button>
    <script>
      let code = "";
      const sidebar = document.getElementById("sidebar");
      const toggleBtn = document.getElementById("toggleSidebar");
      const openBtn = document.getElementById("openSidebar");
      const numpadBtns = document.querySelectorAll(".numpad-btn");
      const validCode = "123456";
      let StationName = ""
      let page = 0

      document.addEventListener("DOMContentLoaded", () => {
        // Animate header
        document.querySelector("header").classList.add("fade-in-down");
        // Animate numpad buttons
        numpadBtns.forEach((btn, index) => {
          setTimeout(
            () => {
              btn.classList.add("show");
            },
            300 + index * 30,
          );
        });
      });
      numpadBtns.forEach((btn) => {
        btn.addEventListener("click", async () => {
          const value = btn.textContent.trim();
          if (value === "Vissza") {
            window.location.href = "/dashboard"
          } else if (btn.id === "backspace") {
            code = code.slice(0, -1);
            updateDisplay();
          }else if (btn.id === "done") {
            
            if (!page == 1) {
              const request = await fetch(`/api/users/get-id/${code}`, {
    method: "GET",
});

const reply = await request.json(); // ✅ Await the JSON response

//console.log(reply); // Debugging

if (Array.isArray(reply) && reply.length > 0) {
    // Assuming _entryId is inside the first object in the array
    document.getElementById("userid").value = reply[0]._entryId || "N/A"; 
    document.getElementById("profile-desc").innerText = `Név: ${reply[0].data.name}\nAzonosító: ${reply[0].data.number}\nOsztály: ${reply[0].data.class}\n∑ ${reply[0].data.points} pont`
    sidebar.classList.remove("-translate-x-full");
} else {
    document.getElementById("done").disabled = true
    sidebar.classList.add("bg-red-500/100")
    document.getElementById("profile-title").innerText = `Hiba`
    document.getElementById("profile-desc").innerText = `Felhasználó nem található!\nPróbáld újra!\n\nVisszatérés 3mp múlva...`
    const errorSound = new Audio("/api/sounds/hands_on_steering_wheel.mp3")

    errorSound.play()
    sidebar.classList.remove("-translate-x-full");
    console.error("Invalid or empty response:", reply);
    setInterval(() => {
       document.getElementById("profile-desc").innerText = `Felhasználó nem található!\nPróbáld újra!\n\nVisszatérés 2mp múlva...`
      setInterval(() => {
         document.getElementById("profile-desc").innerText = `Felhasználó nem található!\nPróbáld újra!\n\nVisszatérés 1mp múlva...`
          setInterval(() => {
             document.getElementById("profile-desc").innerText = `Felhasználó nem található!\nPróbáld újra!\n\nVisszatérés...`
             window.location.reload()
          }, 1000);
        }, 1000);
      }, 1000);
}

code = "";
updateDisplay();
document.getElementById("desc").innerText = `Adja meg a szerzett pontot. (Maximum: ${data[0].data.points})`;
page += 1;


            } else {
              const codeInt = parseInt(code);
              const pointsInt = parseInt(data[0].data.points);

              if (codeInt <= pointsInt) {
                document.getElementById("point").value = codeInt
                //console.log("Subform");
                subform();
              } else {
                const errorSound = new Audio("/api/sounds/hands_on_steering_wheel.mp3")

    errorSound.play()
                document.getElementById("desc").innerText = `A maximumnál több pont nem adható! (Max: ${data[0].data.points})`;
              }
            }
          } else if ( code.length < 6) {
            code += value;
            updateDisplay();
            if (code.length === 6) {
              // do nothing
            }
          }
        });
      });
      function updateDisplay() {
        if (code === "") {
          code = ""
          document.getElementById("code").innerText = code
        } else {
          document.getElementById("code").innerText = code
        }

        
        //console.log(code)
      }
      let data;
      async function fetchStationData() {
        const url = new URL(window.location.href);
        const stationId = url.searchParams.get("id");


        if (!stationId) {
          window.location.href = "/"
        }

        try {
          const response = await fetch(`/api/stations/get/${stationId}`, {
            method: "GET",
          });

          data = await response.json(); // Parse the JSON response
          //console.log(data);
        } catch (error) {
          console.error("Error:", error); // Handle errors
        }

        document.getElementById("stationName").innerText = `Állomás: ${data[0].data.name} (Azonosító: ${data[0].data.number})`
        document.getElementById("stationid").value = data[0].data._id
        document.title = `Sorverseny | ${data[0].data.name} (#${data[0].data.number})`
        StationName = data[0].data.name
      }

      async function subform(){

        const formData = new FormData(document.getElementById("newUserForm"));

        
        const successSound = new Audio("/api/sounds/park_assist_orange.mp3")

   successSound.play()
   const overlay = document.createElement("div");
          overlay.className =
            "fixed inset-0 bg-white bg-opacity-95 flex items-center justify-center z-50 opacity-0 transition-opacity duration-300";
          overlay.innerHTML = `
      <div class="text-center">
      <div class="inline-block w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin" id="loadingSpinner"></div>
      <div class="hidden text-primary text-6xl mb-2" id="successIcon"><i class="ri-checkbox-circle-fill"></i></div>
      <p class="mt-4 text-lg text-[#1D1D1F] font-medium" style="font-family: 'SF Pro Display', -apple-system, sans-serif" id="statusText">Érvényesítés...</p>
      </div>
      `;
          document.body.appendChild(overlay);
          requestAnimationFrame(() => {
            overlay.style.opacity = "1";
          });

          const loadingSpinner = overlay.querySelector("#loadingSpinner");
            const successIcon = overlay.querySelector("#successIcon");
            const statusText = overlay.querySelector("#statusText");
            loadingSpinner.style.display = "none";
            successIcon.style.display = "block";
            statusText.textContent = "Érvényesítve!";
        const response = await fetch('/api/points/register', {
            method: "POST",
            body: new URLSearchParams(formData),
        })

        setInterval(() => {
          window.location.reload()
        }, 1000);

        document.getElementById("newUserForm").reset();
      };

    fetchStationData();
    
      toggleBtn.addEventListener("click", () => {
        sidebar.classList.add("-translate-x-full");
        openBtn.classList.remove("hidden");
      });
    
      openBtn.addEventListener("click", () => {
        sidebar.classList.remove("-translate-x-full");
        openBtn.classList.add("hidden");
      });

      document.getElementById('supportCallBtn').addEventListener('click', async function () {
        const confirmed = confirm('Biztos, hogy szeretnél segítséget hívni?');

        if (confirmed) {

          await fetch(`/api/support/request/${StationName}`, {
            method: 'POST',
            headers: {},
            body: {},
          })
          .then(res => res.json())
          .then(data => console.log(data))
          .catch(err => console.error(err));

          alert("Egyik adminisztrátort értesítettük!")

          console.log('Support call initiated');
        }
      });
    </script> 
    <script src="/js/auth.js"></script>
  </body>
</html>
